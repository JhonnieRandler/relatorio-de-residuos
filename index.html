<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relatório de Resíduos Gerados</title>
    <!-- Metadados para SEO e Descrição da Página -->
    <meta
      name="description"
      content="Ferramenta prática e gratuita para gestão de resíduos gerados, com extração de dados de PDFs e geração de relatórios."
    />
    <meta name="author" content="Jhon Randler" />
    <meta
      name="keywords"
      content="gestão de resíduos, relatório de resíduos, PDF, extração de dados, MTR, histórico de resíduos, ferramenta gratuita"
    />

    <!-- Open Graph Metadados para Redes Sociais (Facebook, WhatsApp, LinkedIn) -->
    <meta property="og:title" content="Relatório de Resíduos Gerados" />
    <meta
      property="og:description"
      content="Ferramenta prática e gratuita para gestão de resíduos gerados, com extração de dados de PDFs e geração de relatórios."
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://jhonnierandler.github.io/relatorio-de-residuos"
    />
    <!-- IMPORTANTE: Usar URL absoluta para a imagem para funcionar no WhatsApp e outras plataformas -->
    <!-- Ajustado para o tamanho real da imagem (408x408) -->
    <meta
      property="og:image"
      content="https://jhonnierandler.github.io/relatorio-de-residuos/footer.png"
    />
    <meta property="og:image:width" content="408" />
    <meta property="og:image:height" content="408" />
    <meta property="og:locale" content="pt_BR" />

    <!-- Twitter Card Metadados -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Relatório de Resíduos Gerados" />
    <meta
      name="twitter:description"
      content="Ferramenta prática e gratuita para gestão de resíduos gerados, com extração de dados de PDFs e geração de relatórios."
    />
    <meta
      name="twitter:image"
      content="https://jhonnierandler.github.io/relatorio-de-residuos/footer.png"
    />
    <meta name="twitter:creator" content="@JhonnieRandler" />
    <!-- Altere @SeuHandleTwitter para o seu handle do Twitter, se tiver um -->

    <link rel="icon" type="image/png" href="footer.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      /* Adiciona box-sizing universal para um modelo de caixa consistente */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        /* Impede a rolagem horizontal da página principal */
        overflow-x: hidden;
      }
      main {
        flex: 1 0 auto;
        /* Usar 100% da largura do corpo, e o padding garantirá o espaçamento */
        width: 100%;
        max-width: 95%; /* Define uma largura máxima para o conteúdo principal */
        margin: 20px auto; /* Centraliza o conteúdo principal */
        padding: 0 20px; /* Adiciona padding nas laterais, agora incluído na largura total devido ao box-sizing */
        text-align: center;
      }
      h1 {
        color: #333;
        margin-bottom: 20px;
      }
      .input-container {
        display: flex;
        justify-content: center;
        margin: 20px 0;
      }
      input[type="file"] {
        display: none;
      }
      .custom-file-upload {
        display: inline-block;
        padding: 12px 20px;
        background-color: #ffffff;
        color: #333;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s, transform 0.2s; /* Adiciona transição de transformação */
      }
      .custom-file-upload:hover {
        background-color: #4caf50;
        color: white;
        transform: translateY(-2px); /* Efeito de elevação no hover */
      }
      .custom-file-upload i {
        margin-right: 8px;
      }
      #textOutput {
        margin-top: 20px;
      }
      .table-container {
        overflow-x: auto; /* Permite que o conteúdo da tabela role horizontalmente dentro do contêiner */
        width: 100%; /* Garante que o contêiner da tabela ocupe toda a largura disponível do seu pai (main) */
        margin-bottom: 20px; /* Adicionado margem inferior para separar do botão de copiar */
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #e0e0e0;
        font-weight: bold;
      }
      button {
        padding: 10px 20px;
        margin: 10px 0;
        background-color: #ffffff;
        color: #333;
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s, transform 0.2s; /* Adiciona transição de transformação */
      }
      button:hover {
        background-color: #4caf50;
        color: white;
        transform: translateY(-2px); /* Efeito de elevação no hover */
      }
      .history-button {
        margin: 10px 0;
        padding: 10px;
        background-color: #ffffff;
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s; /* Adiciona transição de transformação */
      }
      .history-button:hover {
        background-color: #4caf50;
        color: white;
        transform: translateY(-2px); /* Efeito de elevação no hover */
      }
      #error,
      #messageBox {
        color: red;
        background-color: #ffe0e0;
        border: 1px solid red;
        padding: 10px;
        margin-top: 10px;
        border-radius: 8px;
        display: none;
      }
      #messageBox.success {
        color: green;
        background-color: #e0ffe0;
        border-color: green;
      }
      footer {
        flex: 0 0 auto;
        width: 100%; /* Ajustado para 100% e confiar no overflow-x: hidden do body */
        background-color: #ffcead;
        padding: 15px;
        text-align: center;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        box-sizing: border-box;
      }
      footer img {
        max-width: 100px;
        height: auto;
        cursor: pointer; /* Adicionado cursor para indicar interatividade */
      }
      footer p {
        color: #333;
        font-size: 14px;
        margin: 0;
        flex: 1;
        overflow-wrap: break-word;
      }
      @media screen and (max-width: 600px) {
        main {
          padding: 10px;
        }
        h1 {
          font-size: 24px;
        }
        .custom-file-upload {
          padding: 10px 16px;
          font-size: 14px;
        }
        th,
        td {
          padding: 5px;
          font-size: 13px;
        }
        button {
          padding: 8px 16px;
          font-size: 14px;
        }
        .history-button {
          padding: 8px;
          font-size: 14px;
        }
        footer {
          flex-direction: column;
          padding: 10px 15px;
        }
        footer img {
          max-width: 80px;
          margin-bottom: 10px;
        }
        footer p {
          font-size: 12px;
          max-width: 100%;
        }
      }

      /* Estilos para o Modal de Alerta Customizado */
      .modal-overlay {
        display: none; /* Escondido por padrão */
        position: fixed; /* Fica no lugar */
        z-index: 1000; /* Fica acima de tudo */
        left: 0;
        top: 0;
        width: 100%; /* Largura total */
        height: 100%; /* Altura total */
        overflow: auto; /* Habilita rolagem se necessário */
        background-color: rgba(0, 0, 0, 0.4); /* Fundo preto com opacidade */
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Largura responsiva */
        max-width: 400px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        text-align: center;
      }

      .modal-buttons button {
        padding: 10px 15px;
        margin: 10px 5px 0;
        border-radius: 5px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        transition: background-color 0.3s ease;
      }

      .modal-buttons button:hover {
        opacity: 0.9;
      }
      .modal-image {
        max-width: 80px; /* Ajuste o tamanho conforme necessário */
        height: auto;
        margin-bottom: 15px;
        display: none; /* Escondido por padrão, será exibido via JS */
        margin: 0 auto 15px auto; /* CENTRALIZAÇÃO HORIZONTAL AQUI */
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Relatório de Resíduos Gerados</h1>
      <div class="input-container">
        <label for="pdfInput" class="custom-file-upload">
          <i class="fas fa-upload"></i> Selecionar PDFs
        </label>
        <input type="file" id="pdfInput" accept="application/pdf" multiple />
      </div>
      <button
        class="history-button"
        id="historyButton"
        onclick="window.location.href='historico/'"
      >
        <i class="fas fa-history"></i> Histórico
      </button>
      <div id="textOutput"></div>
      <div id="error"></div>
      <div id="messageBox"></div>
      <!-- Adicionado para mensagens de sucesso/erro -->
    </main>
    <footer>
      <img id="footerImage" src="footer.png" alt="Footer Image" />
      <p>
        Este site foi desenvolvido para facilitar a gestão de resíduos gerados,
        oferecendo uma ferramenta prática e acessível. É livre para uso por
        todos!
      </p>
    </footer>

    <!-- Modal de Alerta Customizado -->
    <div id="customAlertModal" class="modal-overlay">
      <div class="modal-content">
        <img
          id="alertModalImage"
          src=""
          alt="Ícone de Status"
          class="modal-image"
        />
        <p id="alertMessage"></p>
        <div class="modal-buttons">
          <button id="alertOkBtn">OK</button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      // Configura o worker do PDF.js
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

      // Envolve todo o código principal em um listener DOMContentLoaded
      document.addEventListener("DOMContentLoaded", () => {
        // Mapeamento de códigos IBAMA para tipos, ajustado para consistência
        const ibamaCodeToType = {
          191213: "NÃO RECICLÁVEL",
          150202: "CONTAMINADO",
          "030101": "MADEIRA",
          "030301": "MADEIRA",
          "030308": "PAPEL",
          200139: "PLÁSTICO",
          200108: "ORGÂNICO",
          170503: "SOLO CONTAMINADO",
          170407: "SUCATA FERROSA",
          190899: "EFLUENTE SANITÁRIO",
          130201: "ÓLEO QUEIMADO",
          130507: "ÁGUA E ÓLEO",
        };
        const rccCodes = [
          "170201",
          "170202",
          "170203",
          "170401",
          "170402",
          "170403",
          "170404",
          "170405",
          "170406",
          "170411",
          "170412",
          "170413",
          "170802",
        ];

        // Função para exibir modais de alerta com imagem
        function showAlertModal(message, type) {
          // type: 'success', 'exists', 'no_data', 'error'
          const modal = document.getElementById("customAlertModal");
          const alertMessage = document.getElementById("alertMessage");
          const alertModalImage = document.getElementById("alertModalImage");
          const okBtn = document.getElementById("alertOkBtn");

          if (alertMessage) alertMessage.textContent = message;
          if (modal) modal.classList.remove("success", "error"); // Limpa classes anteriores para evitar conflitos

          let imagePath = "";
          if (type === "success") {
            imagePath = "like.png";
            if (okBtn) okBtn.style.backgroundColor = "#4CAF50"; // Verde para sucesso
          } else if (type === "exists") {
            imagePath = "point.png";
            if (okBtn) okBtn.style.backgroundColor = "#FFA000"; // Laranja para "já existente"
          } else if (type === "no_data" || type === "error") {
            imagePath = "doubt.png";
            if (okBtn) okBtn.style.backgroundColor = "#f44336"; // Vermelho para erro/falha
          }

          if (alertModalImage) {
            alertModalImage.src = imagePath;
            alertModalImage.style.display = "block";
          }

          if (modal) modal.style.display = "flex";

          const handleOk = () => {
            if (modal) modal.style.display = "none";
            if (okBtn) okBtn.removeEventListener("click", handleOk);
            if (alertModalImage) alertModalImage.style.display = "none"; // Oculta a imagem ao fechar
          };
          if (okBtn) okBtn.addEventListener("click", handleOk);
        }

        // Função para extrair dados do texto (usada por processPdfFile)
        function extractData(text) {
          const extracted = {};

          const dataEmissaoMatch = text.match(
            /Data\s*da\s*emissão:?\s*(\d{2}\/\d{2}\/\d{4})/i
          );
          extracted.dataEmissao = dataEmissaoMatch
            ? dataEmissaoMatch[1]
            : "Não encontrada";

          const mtrMatch = text.match(/MTR\s*n[ºo]:?\s*(\d+)/i);
          extracted.mtr = mtrMatch ? mtrMatch[1] : "Não encontrado";
          extracted.mtrFormatted = mtrMatch
            ? `MTR nº: ${mtrMatch[1]}`
            : "Não encontrado";

          const mtrRefMatch = text.match(
            /Referente\s*ao\s*(?:MTR|Ticket\s*CCO)\s*(\d+)/i
          );
          extracted.mtrRef = mtrRefMatch ? mtrRefMatch[1] : "N/A";

          const razaoInicialMatches = text.matchAll(
            /Raz[ãa]o\s*Social:?\s*([^:]+?)(?=\s*(?:Raz[ãa]o\s*Social|Telefone|Endereço|$))/gi
          );
          let razoesIniciais = Array.from(razaoInicialMatches, (match) =>
            match[1].trim().split("-")[0].trim()
          );

          const razaoDestinadorMatch = text.match(
            /Identificação\s*do\s*Destinador.*?Raz[ãa]o\s*Social:?\s*([^:]+?)(?=\s*(?:Estado|Município|$))/is
          );
          const razaoDestinador = razaoDestinadorMatch
            ? razaoDestinadorMatch[1].trim().split("-")[0].trim()
            : null;

          let razoesSociais = [...razoesIniciais];
          if (razaoDestinador) razoesSociais.push(razaoDestinador);
          razoesSociais = razoesSociais.filter(
            (razao) =>
              !razao
                .toUpperCase()
                .includes("CONSORCIO CONSTRUTOR FERROVIA LUCAS DO RIO VERDE")
          );

          extracted.razaoSocial1 =
            razoesSociais.length > 0 ? razoesSociais[0] : "Não encontrada";
          extracted.razaoSocial2 =
            razoesSociais.length > 1
              ? razoesSociais[1]
              : razoesSociais.length === 1
              ? razoesSociais[0]
              : "Não encontrada";

          const estadoFisicoMatch = text.match(/.*?(SÓLIDO|LÍQUIDO)\s*CLASSE/i);
          extracted.estadoFisico = estadoFisicoMatch
            ? estadoFisicoMatch[1]
            : "Não encontrado";

          const quantidadeMatch = text.match(/Qtde.*?(\d+,\d{4})/i);
          let quantidade = quantidadeMatch
            ? quantidadeMatch[1]
            : "Não encontrada";

          const unidadeMatch = text.match(/\s(KG|TON)\s/i);
          const unidade = unidadeMatch ? unidadeMatch[1].toUpperCase() : "";

          const ibamaMatch = text.match(
            /Código\s*IBAMA\s*e\s*Denominação.*?(\d{6}(?:\(*\))?)/is
          );
          const ibamaCode = ibamaMatch
            ? ibamaMatch[1].replace(/\(.*\)/, "").trim()
            : "Não encontrado";
          if (ibamaCode === "Não encontrado") {
            extracted.tipo = "Não encontrado";
          } else if (ibamaCodeToType[ibamaCode]) {
            extracted.tipo = ibamaCodeToType[ibamaCode];
          } else if (rccCodes.includes(ibamaCode)) {
            extracted.tipo = "RCC";
          } else {
            extracted.tipo = ibamaCode;
          }

          extracted.litros =
            extracted.estadoFisico === "LÍQUIDO" ? quantidade : "";
          extracted.toneladas =
            extracted.estadoFisico === "SÓLIDO" ? quantidade : "";
          if (
            extracted.toneladas &&
            unidade === "KG" &&
            extracted.tipo === "RCC"
          ) {
            extracted.toneladas = (
              parseFloat(quantidade.replace(",", ".")) / 1000
            )
              .toFixed(4)
              .replace(".", ",");
          }

          return extracted;
        }

        // Função original para processar um único arquivo PDF
        async function processPdfFile(file) {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

          let fullText = "";
          for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const textContent = await page.getTextContent();
            const pageText = textContent.items
              .map((item) => item.str)
              .join(" ");
            fullText += pageText + " ";
          }
          return extractData(fullText); // Chama a função extractData
        }

        // Função para trocar a imagem do rodapé
        function swapFooterImage(imgElement) {
          const originalSrc = imgElement.src;
          const blinkSrc = originalSrc.replace("footer.png", "blink.png");

          imgElement.src = blinkSrc;
          setTimeout(() => {
            imgElement.src = originalSrc;
          }, 400); // Alterado para 400 milissegundos
        }

        document
          .getElementById("pdfInput")
          .addEventListener("change", async (event) => {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const textOutput = document.getElementById("textOutput");
            const errorDiv = document.getElementById("error");
            const messageBox = document.getElementById("messageBox");

            if (textOutput) textOutput.innerHTML = "Carregando...";
            if (errorDiv) errorDiv.style.display = "none";
            if (messageBox) {
              messageBox.style.display = "none";
              messageBox.classList.remove("success", "error");
            }

            try {
              // Cria um array de promessas para processar cada PDF
              const processingPromises = Array.from(files).map((file) =>
                processPdfFile(file)
              );
              const extractedDataList = await Promise.all(processingPromises);

              let storedData = JSON.parse(
                localStorage.getItem("residuosData") || "[]"
              );
              // Filtra dados antes de salvar, removendo aqueles com "Não encontrada" ou "Não encontrado" em colunas críticas
              const filteredData = extractedDataList.filter(
                (item) =>
                  item.dataEmissao !== "Não encontrada" &&
                  item.mtrFormatted !== "Não encontrado" &&
                  item.razaoSocial1 !== "Não encontrada" &&
                  item.razaoSocial2 !== "Não encontrada" &&
                  item.tipo !== "Não encontrado"
              );

              // Filtra novos dados para evitar duplicatas antes de adicionar ao storedData
              const newUniqueData = filteredData.filter((newItem) => {
                // Verifica se o newItem já existe em storedData
                const isDuplicate = storedData.some(
                  (existingItem) =>
                    existingItem.mtrFormatted === newItem.mtrFormatted &&
                    existingItem.dataEmissao === newItem.dataEmissao
                );
                return !isDuplicate;
              });

              // Adiciona apenas os dados únicos ao storedData
              if (newUniqueData.length > 0) {
                storedData = storedData.concat(newUniqueData);
                localStorage.setItem(
                  "residuosData",
                  JSON.stringify(storedData)
                );
              }

              let tableRows = filteredData
                .map(
                  (data) => `
            <tr>
              <td>${data.dataEmissao}</td>
              <td>${data.mtrFormatted}</td>
              <td>${data.razaoSocial1}</td>
              <td>${data.razaoSocial2}</td>
              <td>${data.tipo}</td>
              <td>${data.mtrRef}</td>
              <td>${data.litros}</td>
              <td>${data.toneladas}</td>
            </tr>
          `
                )
                .join("");

              if (textOutput) {
                textOutput.innerHTML = `
                  <button id="copyButton"><i class="fas fa-copy"></i> Copiar</button>
                  <div class="table-container">
                    <table>
                      <thead>
                        <tr>
                          <th>DATA</th>
                          <th>MTR</th>
                          <th>TRANSPORTADOR</th>
                          <th>DESTINADOR</th>
                          <th>TIPO</th>
                          <th>TICKET</th>
                          <th>LITROS</th>
                          <th>TONELADAS</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${tableRows}
                      </tbody>
                    </table>
                  </div>
                `;
              }

              const copyButton = document.getElementById("copyButton");
              if (copyButton) {
                copyButton.addEventListener("click", () => {
                  const tableRowsToCopy = document.querySelectorAll(
                    "#textOutput table tbody tr"
                  );
                  if (tableRowsToCopy.length > 0) {
                    const copyText = Array.from(tableRowsToCopy)
                      .map((row) => {
                        return Array.from(row.cells)
                          .map((cell) => cell.textContent)
                          .join("\t");
                      })
                      .join("\n");

                    navigator.clipboard
                      .writeText(copyText)
                      .then(() => {
                        showAlertModal(
                          "Dados copiados para a área de transferência!",
                          "success"
                        );
                      })
                      .catch((err) => {
                        console.error("Erro ao copiar:", err);
                        showAlertModal("Erro ao copiar os dados.", "error");
                      });
                  } else {
                    showAlertModal("Nenhum dado para copiar.", "no_data");
                  }
                });
              }

              if (newUniqueData.length > 0) {
                showAlertModal(
                  "Dados extraídos e salvos com sucesso!",
                  "success"
                );
              } else if (filteredData.length > 0) {
                showAlertModal(
                  "Os PDFs contêm dados já existentes no histórico. Nenhum novo dado foi adicionado.",
                  "exists"
                );
              } else {
                showAlertModal(
                  "Nenhum dado válido foi extraído dos PDFs.",
                  "no_data"
                );
              }
            } catch (error) {
              console.error("Erro ao processar os PDFs:", error);
              if (errorDiv) {
                errorDiv.textContent =
                  "Erro ao extrair texto dos PDFs. Verifique se os arquivos são válidos.";
                errorDiv.style.display = "block";
              }
              if (textOutput) textOutput.innerHTML = "";
              showAlertModal(
                "Erro ao processar os PDFs. Verifique se os arquivos são válidos.",
                "error"
              );
            } finally {
              updateHistoryButtonVisibility();
            }
          });

        // Função para atualizar a visibilidade do botão de histórico
        function updateHistoryButtonVisibility() {
          const historyButton = document.getElementById("historyButton");
          const storedData = JSON.parse(
            localStorage.getItem("residuosData") || "[]"
          );
          if (historyButton) {
            if (storedData.length > 0) {
              historyButton.style.display = "inline-block";
            } else {
              historyButton.style.display = "none";
            }
          }
        }

        // Adiciona listener para a imagem do rodapé
        const footerImage = document.getElementById("footerImage");
        if (footerImage) {
          footerImage.addEventListener("click", () =>
            swapFooterImage(footerImage)
          );
        }

        // Chamada inicial para garantir que o botão esteja no estado correto ao carregar a página
        updateHistoryButtonVisibility();
      }); // Fechamento do DOMContentLoaded
    </script>
  </body>
</html>
