<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Histórico de Resíduos - Sua Ferramenta de Gestão</title>
    <!-- Metadados para SEO e Descrição da Página -->
    <meta
      name="description"
      content="Acompanhe o histórico dos seus relatórios de resíduos, visualize dados e gráficos de forma eficiente."
    />
    <meta name="author" content="Jhon Randler" />
    <meta
      name="keywords"
      content="histórico de resíduos, gestão de resíduos, relatórios, gráficos, análise de dados, MTR, ferramenta gratuita"
    />

    <!-- Open Graph Metadados para Redes Sociais (Facebook, WhatsApp, LinkedIn) -->
    <meta
      property="og:title"
      content="Histórico de Resíduos - Sua Ferramenta de Gestão"
    />
    <meta
      property="og:description"
      content="Acompanhe o histórico dos seus relatórios de resíduos, visualize dados e gráficos de forma eficiente."
    />
    <meta property="og:type" content="website" />
    <!-- IMPORTANTE: A URL deve ser a URL final da página do histórico publicada -->
    <meta
      property="og:url"
      content="https://jhonnierandler.github.io/relatorio-de-residuos/historico/"
    />
    <!-- IMPORTANTE: Usar URL absoluta para a imagem para funcionar no WhatsApp e outras plataformas -->
    <!-- Ajustado para o tamanho real da imagem (408x408) -->
    <meta
      property="og:image"
      content="https://jhonnierandler.github.io/relatorio-de-residuos/footer.png"
    />
    <meta property="og:image:width" content="408" />
    <!-- Ajustado para 408 -->
    <meta property="og:image:height" content="408" />
    <!-- Ajustado para 408 -->
    <meta property="og:locale" content="pt_BR" />

    <!-- Twitter Card Metadados -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Histórico de Resíduos - Sua Ferramenta de Gestão"
    />
    <meta
      name="twitter:description"
      content="Acompanhe o histórico dos seus relatórios de resíduos, visualize dados e gráficos de forma eficiente."
    />
    <meta
      name="twitter:image"
      content="https://jhonnierandler.github.io/relatorio-de-residuos/footer.png"
    />
    <meta name="twitter:creator" content="@JhonnieRandler" />

    <link rel="icon" type="image/png" href="../footer.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- Preload das imagens para carregamento mais rápido -->
    <link rel="preload" as="image" href="../doubt.png" />
    <link rel="preload" as="image" href="../footer.png" />
    <link rel="preload" as="image" href="../blink.png" />
    <link rel="preload" as="image" href="../like.png" />
    <link rel="preload" as="image" href="../point.png" />
    <link rel="preload" as="image" href="../sure.png" />
    <!-- Preload do áudio -->
    <link rel="preload" as="audio" href="../blink.mp3" />
    <style>
      :root {
        /* Cores do tema claro */
        --background-color: #f5f5f5;
        --text-color: #333;
        --header-color: #333;
        --button-bg-color: #ffffff;
        --button-text-color: #333;
        --button-hover-bg-color: #4caf50;
        --button-hover-text-color: white;
        --table-header-bg: #e0e0e0;
        --table-border-color: #ccc;
        --table-row-bg: #ffffff;
        --modal-bg-color: #fefefe;
        --footer-bg-color: #ffcead;
        --box-shadow-color: rgba(0, 0, 0, 0.1);
        --input-border-color: #ccc;

        /* Cores específicas para o botão de tema no modo claro */
        --theme-toggle-normal-bg: #ffffff;
        --theme-toggle-normal-color: #333;
        --theme-toggle-hover-bg: #000000;
        --theme-toggle-hover-color: #ffffff;
      }

      [data-theme="dark"] {
        /* Cores do tema noturno */
        --background-color: #1a1a1a;
        --text-color: #e0e0e0;
        --header-color: #f5f5f5;
        --button-bg-color: #333333;
        --button-text-color: #e0e0e0;
        --button-hover-bg-color: #367d39;
        --button-hover-text-color: white;
        --table-header-bg: #444444;
        --table-border-color: #555;
        --table-row-bg: #2b2b2b;
        --modal-bg-color: #333333;
        --footer-bg-color: #3d2a21; /* Um marrom mais escuro para o rodapé */
        --box-shadow-color: rgba(255, 255, 255, 0.1);
        --input-border-color: #666; /* Bordas dos inputs no tema escuro */

        /* Cores específicas para o botão de tema no modo noturno */
        --theme-toggle-normal-bg: #333333;
        --theme-toggle-normal-color: #e0e0e0;
        --theme-toggle-hover-bg: #ffffff;
        --theme-toggle-hover-color: #ffa500; /* Laranja/Amarelo */
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      /* Adiciona box-sizing universal para um modelo de caixa consistente */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        /* Impede a rolagem horizontal da página principal */
        overflow-x: hidden;
        transition: background-color 0.3s ease, color 0.3s ease; /* Transição suave para o tema */
      }
      main {
        flex: 1 0 auto;
        /* Aumentado para 95% da largura da tela */
        width: 100%; /* Garante que ocupe o máximo possível */
        max-width: 95%; /* Nova largura máxima */
        margin: 20px auto; /* Centraliza o conteúdo principal */
        padding: 0 20px; /* Adiciona padding nas laterais, agora incluído na largura total devido ao box-sizing */
        text-align: center;
      }
      h1 {
        color: var(--header-color);
        margin-bottom: 20px;
      }
      .table-container {
        overflow-x: auto;
        width: 100%; /* Ocupa 100% da largura do main, que agora é 95% da tela */
        margin: 0 auto 20px;
        transition: opacity 0.3s ease; /* Adiciona transição para ocultar/exibir */
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background-color: var(--table-row-bg);
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--box-shadow-color);
        color: var(--text-color);
      }
      th {
        background-color: var(--table-header-bg);
        font-weight: bold;
        cursor: pointer;
        padding: 8px;
        text-align: left;
        color: var(--text-color);
        transition: background-color 0.3s ease, color 0.3s ease; /* Transição para o hover */
      }
      th:hover {
        background-color: #d0d0d0; /* Manter um hover mais claro ou ajustar para o tema */
      }
      [data-theme="dark"] th:hover {
        color: black; /* Fonte preta no hover em modo noturno */
        background-color: #cccccc; /* Fundo mais claro para contrastar com texto preto */
      }
      td {
        border: 1px solid var(--table-border-color);
        padding: 8px;
        text-align: left;
      }
      th .sort-arrow {
        margin-left: 5px;
        font-size: 0.8em;
      }
      /* Novo contêiner para input de filtro e select de meses */
      .filter-controls-group {
        display: flex;
        flex-wrap: nowrap; /* Por padrão, não quebra os itens internos */
        gap: 5px;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto; /* Não cresce nem encolhe por padrão, baseia-se no conteúdo */
        min-width: calc(
          180px + 150px + 5px
        ); /* Largura mínima combinada dos filhos + gap */
      }
      .filter-input-wrapper {
        /* Contêiner para o input de filtro e botão de limpar */
        position: relative;
        display: flex; /* Usa flex para alinhar input e botão */
        align-items: center;
        flex: 1 1 220px; /* Base de 220px, pode crescer/diminuir */
        min-width: 180px; /* Largura mínima para o input */
      }
      .filter-input,
      .month-select {
        margin: 0; /* Remove margem para não interferir com flex */
        padding: 8px;
        width: 100%; /* Preenche o contêiner */
        background-color: var(
          --button-bg-color
        ); /* Usar cor de botão para inputs */
        color: var(
          --button-text-color
        ); /* Usar cor de texto de botão para inputs */
        border: 1px solid var(--input-border-color); /* Adicionar borda para visibilidade no dark mode */
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--box-shadow-color);
        outline: none;
        transition: background-color 0.3s ease, color 0.3s ease,
          border-color 0.3s ease, box-shadow 0.3s ease;
      }
      .filter-input {
        padding-right: 30px; /* Espaço para o ícone de limpar */
      }
      .month-select {
        flex: 1 1 180px; /* Base de 180px para o select */
        min-width: 150px;
      }
      .clear-filter {
        position: absolute; /* Posição absoluta dentro do wrapper */
        right: 5px; /* Ajustado para melhor posicionamento */
        top: 50%;
        transform: translateY(-50%); /* Centraliza verticalmente */
        padding: 0;
        width: 20px;
        height: 20px;
        background: transparent;
        border: none;
        box-shadow: none;
        cursor: pointer;
        display: none;
        transition: none; /* Remove transição para evitar movimento no hover */
        margin: 0; /* REMOVIDA MARGEM AQUI */
      }
      .clear-filter i {
        color: var(--text-color); /* X segue a cor do texto do tema */
        font-size: 14px;
        transition: color 0.3s ease;
      }
      .clear-filter:hover {
        background: transparent; /* Sem fundo no hover */
        border: none; /* Sem borda no hover */
        box-shadow: none; /* Sem sombra no hover */
        transform: translateY(-50%); /* Mantém o botão centralizado no hover */
      }
      .clear-filter:hover i {
        color: #ff4444; /* X vermelho no hover, mantendo contraste */
      }
      #chartContainer {
        width: 100%;
        margin: 20px auto;
        height: 800px;
        padding: 10px;
        box-sizing: border-box;
        display: block;
        /* Adicionado para a borda do gráfico */
        border: 1px solid var(--table-border-color);
        border-radius: 8px;
        background-color: var(
          --table-row-bg
        ); /* Fundo do contêiner do gráfico segue o tema */
        min-height: 400px; /* Adicionado altura mínima para depuração */
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      canvas {
        max-width: 100%;
        height: 100%;
        display: block;
        margin: 0 auto;
        width: 100%;
      }
      .buttons {
        margin: 10px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px; /* Espaçamento entre os itens flex */
        flex-wrap: wrap; /* Permite que os itens quebrem para a próxima linha */
      }
      button {
        padding: 10px 20px;
        margin: 5px; /* Ajuste a margem para melhor espaçamento com flex-wrap */
        background-color: var(--button-bg-color);
        color: var(--button-text-color);
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--box-shadow-color);
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s, transform 0.2s, color 0.3s ease,
          box-shadow 0.3s ease;
      }
      button:hover {
        background-color: var(--button-hover-bg-color);
        color: var(--button-hover-text-color);
        transform: translateY(-2px);
      }
      footer {
        flex: 0 0 auto;
        width: 100%; /* Ajustado para 100% e confiar no overflow-x: hidden do body */
        background-color: var(--footer-bg-color);
        padding: 15px;
        text-align: center;
        box-shadow: 0 -2px 4px var(--box-shadow-color);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        box-sizing: border-box;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }
      footer img {
        max-width: 100px;
        height: auto;
        cursor: pointer; /* Adicionado cursor para indicar interatividade */
      }
      footer p {
        color: var(--text-color);
        font-size: 14px;
        margin: 0;
        flex: 1;
        overflow-wrap: break-word;
      }
      .theme-toggle-button {
        background-color: var(--theme-toggle-normal-bg);
        color: var(--theme-toggle-normal-color);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        cursor: pointer;
        font-size: 18px;
        box-shadow: 0 2px 4px var(--box-shadow-color);
        transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s,
          box-shadow 0.3s ease;
        margin-left: 10px;
      }

      .theme-toggle-button:hover {
        background-color: var(--theme-toggle-hover-bg);
        color: var(--theme-toggle-hover-color);
        transform: translateY(-2px);
      }
      .header-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
      }
      @media screen and (max-width: 600px) {
        main {
          padding: 10px;
        }
        h1 {
          font-size: 24px;
        }
        /* Ajustes para inputs e select em telas pequenas */
        .filter-controls-group {
          flex-direction: column; /* Empilha os itens verticalmente */
          width: 100%; /* Ocupa largura total */
          gap: 10px;
          flex-wrap: wrap; /* Permite o wrap interno em telas pequenas */
          min-width: auto; /* Reseta o min-width para permitir o empilhamento */
        }
        .filter-input-wrapper,
        .month-select {
          width: 100%; /* Faz com que ocupem a largura total do grupo */
          flex-basis: auto; /* Reseta a base flexível para ocupar 100% */
        }
        #chartContainer {
          height: 500px;
          padding: 5px;
        }
        th,
        td {
          padding: 5px;
          font-size: 13px;
        }
        button {
          padding: 8px 16px;
          font-size: 14px;
        }
        footer {
          flex-direction: column;
          padding: 10px 15px;
        }
        footer img {
          max-width: 80px;
          margin-bottom: 10px;
        }
        footer p {
          font-size: 12px;
          max-width: 100%;
        }
        .header-controls {
          flex-direction: column;
          gap: 10px;
        }
      }

      /* Estilos para o Modal de Confirmação e Alerta */
      .modal-overlay {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: var(--modal-bg-color);
        margin: auto;
        padding: 20px;
        border: 1px solid var(--table-border-color);
        width: 80%;
        max-width: 400px;
        border-radius: 10px;
        box-shadow: 0 4px 8px var(--box-shadow-color);
        text-align: center;
        color: var(--text-color);
        transition: background-color 0.3s ease, border-color 0.3s ease,
          box-shadow 0.3s ease, color 0.3s ease;
      }

      .modal-buttons button {
        padding: 10px 15px;
        margin: 10px 5px 0;
        border-radius: 5px;
        cursor: pointer;
        background-color: var(
          --button-hover-bg-color
        ); /* Botões do modal com cor de hover padrão */
        color: var(--button-hover-text-color);
        border: none;
        transition: background-color 0.3s ease, opacity 0.3s ease;
      }

      .modal-buttons button:hover {
        opacity: 0.9;
      }

      #modalCancelBtn {
        background-color: #f44336; /* Manter vermelho para o cancelar */
      }
      #modalCancelBtn:hover {
        background-color: #d32f2f;
      }
      .modal-image {
        max-width: 80px;
        height: auto;
        margin-bottom: 15px;
        display: none;
        margin: 0 auto 15px auto;
      }
    </style>
  </head>
  <body>
    <main>
      <div class="header-controls">
        <h1>Histórico de Resíduos</h1>
        <button id="themeToggle" class="theme-toggle-button">
          <i class="fas fa-moon"></i>
        </button>
      </div>
      <div class="buttons" id="buttonsContainer">
        <div class="filter-controls-group" id="filterControlsGroup">
          <div class="filter-input-wrapper">
            <input
              type="text"
              class="filter-input"
              id="filterInput"
              placeholder="Filtrar..."
            />
            <button class="clear-filter" id="clearFilter">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <select class="month-select" id="monthFilter">
            <option value="">Todos os Meses</option>
          </select>
        </div>
        <button id="clearHistory" style="display: none">
          <i class="fas fa-trash"></i> Apagar Histórico
        </button>
        <button id="downloadChart" style="display: none">
          <i class="fas fa-download"></i> Baixar Gráfico
        </button>
        <button id="copyButton" style="display: none">
          <i class="fas fa-copy"></i> Copiar
        </button>
        <button id="toggleTableVisibility" style="display: none">
          <i class="fas fa-eye-slash"></i> Ocultar Tabela
        </button>
        <button id="backButton" onclick="redirectToMainPage()">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
      </div>
      <div class="table-container" id="historyTable"></div>
      <div id="chartContainer">
        <canvas id="residuosChart"></canvas>
      </div>
    </main>
    <footer>
      <img id="footerImage" src="../footer.png" alt="Footer Image" />
      <p>
        Este site foi desenvolvido para facilitar a gestão de resíduos gerados,
        oferecendo uma ferramenta prática e acessível. É livre para uso por
        todos!
      </p>
      <!-- Elemento de áudio para o som de blink -->
      <audio id="blinkAudio" preload="auto">
        <source src="../blink.mp3" type="audio/mpeg" />
        Seu navegador não suporta o elemento de áudio.
      </audio>
    </footer>

    <!-- Modal de Confirmação Customizado -->
    <div id="customConfirmModal" class="modal-overlay">
      <div class="modal-content">
        <img
          id="confirmModalImage"
          src=""
          alt="Ícone de Confirmação"
          class="modal-image"
        />
        <p id="modalMessage"></p>
        <div class="modal-buttons">
          <button id="modalConfirmBtn">Sim</button>
          <button id="modalCancelBtn">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Alerta Customizado -->
    <div id="customAlertModal" class="modal-overlay">
      <div class="modal-content">
        <img
          id="alertModalImage"
          src=""
          alt="Ícone de Status"
          class="modal-image"
        />
        <p id="alertMessage"></p>
        <div class="modal-buttons">
          <button id="alertOkBtn">OK</button>
        </div>
      </div>
    </div>

    <script>
      let sortDirection = {};
      let currentSortColumn = null; // Coluna atualmente ordenada
      let currentSortDirection = "asc"; // Direção atual da ordenação ('asc' ou 'desc')
      let storedData = []; // Declarado aqui, será inicializado em DOMContentLoaded
      let isTableVisible = true; // Estado para a visibilidade da tabela

      // Mapeamento de nomes de colunas para chaves de dados
      const columnKeys = {
        DATA: "dataEmissao",
        MTR: "mtrFormatted",
        TRANSPORTADOR: "razaoSocial1",
        DESTINADOR: "razaoSocial2",
        TIPO: "tipo",
        TICKET: "mtrRef",
        LITROS: "litros",
        TONELADAS: "toneladas",
      };

      // Função para alternar o tema
      function toggleTheme() {
        const htmlElement = document.documentElement;
        const currentTheme = htmlElement.getAttribute("data-theme");
        const themeToggleBtn = document.getElementById("themeToggle");

        if (currentTheme === "dark") {
          htmlElement.removeAttribute("data-theme");
          localStorage.setItem("theme", "light");
          if (themeToggleBtn) {
            themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
          }
          // Atualiza o gráfico se ele estiver visible, para redesenhar com as novas cores de texto, etc.
          if (
            window.myChart &&
            document.getElementById("chartContainer").style.display !== "none"
          ) {
            updateChart(storedData);
          }
        } else {
          htmlElement.setAttribute("data-theme", "dark");
          localStorage.setItem("theme", "dark");
          if (themeToggleBtn) {
            themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
          }
          // Atualiza o gráfico se ele estiver visible
          if (
            window.myChart &&
            document.getElementById("chartContainer").style.display !== "none"
          ) {
            updateChart(storedData);
          }
        }
      }

      // Função para aplicar o tema salvo
      function applySavedTheme() {
        const savedTheme = localStorage.getItem("theme");
        const htmlElement = document.documentElement;
        const themeToggleBtn = document.getElementById("themeToggle");

        if (savedTheme === "dark") {
          htmlElement.setAttribute("data-theme", "dark");
          if (themeToggleBtn) {
            themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
          }
        } else {
          htmlElement.removeAttribute("data-theme");
          if (themeToggleBtn) {
            themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
          }
        }
      }

      // Função para redirecionar para a página principal, adaptando-se ao ambiente
      function redirectToMainPage() {
        const isLocal =
          window.location.hostname === "127.0.0.1" ||
          window.location.hostname === "localhost";

        if (isLocal) {
          // Para desenvolvimento local, assume que a página principal está na raiz do servidor
          window.location.href = window.location.origin + "/";
        } else {
          // Para GitHub Pages, usa o caminho absoluto do projeto
          window.location.href =
            "https://jhonnierandler.github.io/relatorio-de-residuos/";
        }
      }

      // Funções para Modais Customizados
      function showConfirmModal(message, onConfirm) {
        const modal = document.getElementById("customConfirmModal");
        const modalMessage = document.getElementById("modalMessage");
        const confirmModalImage = document.getElementById("confirmModalImage");
        const confirmBtn = document.getElementById("modalConfirmBtn");
        const cancelBtn = document.getElementById("modalCancelBtn");

        if (modalMessage) modalMessage.textContent = message;

        if (confirmModalImage) {
          confirmModalImage.src = "../sure.png"; // Caminho relativo da imagem
          confirmModalImage.style.display = "block";
        }

        if (modal) modal.style.display = "flex";

        const handleConfirm = () => {
          onConfirm(true);
          if (modal) modal.style.display = "none";
          if (confirmBtn)
            confirmBtn.removeEventListener("click", handleConfirm);
          if (cancelBtn) cancelBtn.removeEventListener("click", handleCancel);
          if (confirmModalImage) confirmModalImage.style.display = "none"; // Oculta a imagem ao fechar
        };

        const handleCancel = () => {
          onConfirm(false);
          if (modal) modal.style.display = "none";
          if (confirmBtn)
            confirmBtn.removeEventListener("click", handleConfirm);
          if (cancelBtn) cancelBtn.removeEventListener("click", handleCancel);
          if (confirmModalImage) confirmModalImage.style.display = "none"; // Oculta a imagem ao fechar
        };

        if (confirmBtn) confirmBtn.addEventListener("click", handleConfirm);
        if (cancelBtn) cancelBtn.addEventListener("click", handleCancel);
      }

      function showAlertModal(message, type) {
        // type: 'success', 'no_data', 'error'
        const modal = document.getElementById("customAlertModal");
        const alertMessage = document.getElementById("alertMessage");
        const alertModalImage = document.getElementById("alertModalImage");
        const okBtn = document.getElementById("alertOkBtn");

        if (alertMessage) alertMessage.textContent = message;
        if (modal) modal.classList.remove("success", "error");

        let imagePath = "";
        if (type === "success") {
          imagePath = "../like.png"; // Caminho relativo da imagem
          if (okBtn) okBtn.style.backgroundColor = "#4CAF50";
        } else if (type === "no_data") {
          imagePath = "../doubt.png"; // Caminho relativo da imagem
          if (okBtn) okBtn.style.backgroundColor = "#f44336";
        } else if (type === "error") {
          imagePath = "../doubt.png"; // Caminho relativo da imagem
          if (okBtn) okBtn.style.backgroundColor = "#f44336";
        } else if (type === "exists") {
          // Adicionado tipo 'exists'
          imagePath = "../point.png"; // Caminho relativo da imagem
          if (okBtn) okBtn.style.backgroundColor = "#FFA000"; // Laranja para "já existente"
        }

        if (alertModalImage) {
          alertModalImage.src = imagePath;
          alertModalImage.style.display = "block";
        }

        if (modal) modal.style.display = "flex";

        const handleOk = () => {
          if (modal) modal.style.display = "none";
          if (okBtn) okBtn.removeEventListener("click", handleOk);
          if (alertModalImage) alertModalImage.style.display = "none"; // Oculta a imagem ao fechar
        };
        if (okBtn) okBtn.addEventListener("click", handleOk);
      }

      /**
       * Renders the data in the table.
       * @param {Array<Object>} dataToRender The array of MTR objects to display.
       */
      function renderTable(dataToRender) {
        const historyTable = document.getElementById("historyTable");
        if (dataToRender.length === 0) {
          if (historyTable)
            historyTable.innerHTML =
              "<p>Nenhum dado de histórico disponível.</p>";
          return;
        }

        let tableRows = dataToRender
          .map(
            (data) => `
              <tr>
                <td>${data.dataEmissao}</td>
                <td>${data.mtrFormatted}</td>
                <td>${data.razaoSocial1}</td>
                <td>${data.razaoSocial2}</td>
                <td>${data.tipo}</td>
                <td>${data.mtrRef}</td>
                <td>${data.litros}</td>
                <td>${data.toneladas}</td>
              </tr>
            `
          )
          .join("");

        if (historyTable) {
          historyTable.innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th data-column="dataEmissao">DATA <span class="sort-arrow"></span></th>
                    <th data-column="mtrFormatted">MTR <span class="sort-arrow"></span></th>
                    <th data-column="razaoSocial1">TRANSPORTADOR <span class="sort-arrow"></span></th>
                    <th data-column="razaoSocial2">DESTINADOR <span class="sort-arrow"></span></th>
                    <th data-column="tipo">TIPO <span class="sort-arrow"></span></th>
                    <th data-column="mtrRef">TICKET <span class="sort-arrow"></span></th>
                    <th data-column="litros">LITROS <span class="sort-arrow"></span></th>
                    <th data-column="toneladas">TONELADAS <span class="sort-arrow"></span></th>
                  </tr>
                </thead>
                <tbody>
                  ${tableRows}
                </tbody>
              </table>
            `;
        }

        // Add sorting event listeners to headers
        const headers = historyTable.querySelectorAll("th");
        headers.forEach((header) => {
          header.addEventListener("click", () => {
            const column = header.dataset.column;
            sortTable(column);
          });
        });

        // Update sort arrows
        updateSortArrows();
      }

      /**
       * Sorts the data based on the selected column.
       * @param {string} column The data key to sort by.
       */
      function sortTable(column) {
        // Determine sort direction
        if (currentSortColumn === column) {
          currentSortDirection =
            currentSortDirection === "asc" ? "desc" : "asc";
        } else {
          currentSortColumn = column;
          currentSortDirection = "asc";
        }

        const dataToSort = storedData; // Always sort the full storedData

        dataToSort.sort((a, b) => {
          let valA = a[column];
          let valB = b[column];

          // Special handling for numeric values (litros, toneladas, MTR, Ticket)
          if (
            column === "litros" ||
            column === "toneladas" ||
            column === "mtrFormatted" ||
            column === "mtrRef"
          ) {
            // Remove "MTR nº: " prefix for MTR, and handle comma as decimal separator for numbers
            if (column === "mtrFormatted")
              valA = String(valA).replace("MTR nº: ", "");
            if (column === "mtrFormatted")
              valB = String(valB).replace("MTR nº: ", "");

            valA = parseFloat(String(valA).replace(",", ".") || 0);
            valB = parseFloat(String(valB).replace(",", ".") || 0);

            if (isNaN(valA)) valA = -Infinity; // Treat "Não encontrada" or "N/A" as smallest
            if (isNaN(valB)) valB = -Infinity;

            return currentSortDirection === "asc" ? valA - valB : valB - valA;
          }

          // Special handling for date (DD/MM/YYYY)
          if (column === "dataEmissao") {
            // Convert DD/MM/YYYY to YYYY-MM-DD for correct comparison
            const dateA = valA.split("/").reverse().join("-");
            const dateB = valB.split("/").reverse().join("-");
            if (dateA < dateB) return currentSortDirection === "asc" ? -1 : 1;
            if (dateA > dateB) return currentSortDirection === "asc" ? 1 : -1;
            return 0;
          }

          // Default string comparison
          if (typeof valA === "string" && typeof valB === "string") {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
            if (valA < valB) return currentSortDirection === "asc" ? -1 : 1;
            if (valA > valB) return currentSortDirection === "asc" ? 1 : -1;
          }
          return 0;
        });

        // Re-render the table with sorted data and update chart (if necessary based on current filters)
        const filterInput = document.getElementById("filterInput");
        const monthFilter = document.getElementById("monthFilter");
        applyFiltersAndRender(filterInput.value, monthFilter.value);
      }

      /**
       * Updates the sort arrows in the table headers.
       */
      function updateSortArrows() {
        const headers = document.querySelectorAll("#historyTable th");
        headers.forEach((header) => {
          let arrowSpan = header.querySelector(".sort-arrow");
          if (!arrowSpan) {
            // Create if it doesn't exist
            arrowSpan = document.createElement("span");
            arrowSpan.classList.add("sort-arrow");
            header.appendChild(arrowSpan);
          }
          arrowSpan.textContent = ""; // Clear previous arrow
          if (header.dataset.column === currentSortColumn) {
            arrowSpan.textContent =
              currentSortDirection === "asc" ? " ↑" : " ↓";
          }
        });
      }

      document.getElementById("filterInput").addEventListener("input", (e) => {
        applyFiltersAndRender(
          e.target.value,
          document.getElementById("monthFilter").value
        );
        document.getElementById("clearFilter").style.display = e.target.value
          ? "inline-block"
          : "none";
      });

      document
        .getElementById("clearHistory")
        .addEventListener("click", clearHistory);

      function clearHistory() {
        showConfirmModal(
          "Tem certeza que deseja apagar todo o histórico? Esta ação não pode ser desfeita.",
          (confirmed) => {
            if (confirmed) {
              localStorage.removeItem("residuosData");
              // Reatribui storedData para refletir o armazenamento local limpo
              storedData = JSON.parse(
                localStorage.getItem("residuosData") || "[]"
              );
              renderTable([]);
              updateChart([]);
              toggleButtons();
              toggleTableVisibility(false); // Esconde a tabela ao limpar o histórico
              const toggleTableBtn = document.getElementById(
                "toggleTableVisibility"
              );
              if (toggleTableBtn) {
                toggleTableBtn.innerHTML =
                  '<i class="fas fa-eye"></i> Exibir Tabela';
                isTableVisible = false; // Atualiza o estado
              }
            }
          }
        );
      }

      function updateChart(data) {
        const dataToUse = data.length > 0 ? data : storedData;
        const chartContainer = document.getElementById("chartContainer");

        if (dataToUse.length === 0) {
          if (chartContainer) chartContainer.style.display = "none";
          return;
        } else {
          if (chartContainer) chartContainer.style.display = "block";
        }

        const tipos = [
          ...new Set(
            dataToUse
              .map((item) => item.tipo)
              .filter((tipo) => tipo !== "Não encontrado")
          ),
        ];
        const litrosPorTipo = tipos.map((tipo) => {
          const sum = dataToUse
            .filter((item) => item.tipo === tipo && item.litros)
            .reduce(
              (sum, item) =>
                sum + (parseFloat(item.litros.replace(",", ".")) || 0),
              0
            );
          return sum.toFixed(2);
        });
        const toneladasPorTipo = tipos.map((tipo) => {
          const sum = dataToUse
            .filter((item) => item.tipo === tipo && item.toneladas)
            .reduce(
              (sum, item) =>
                sum + (parseFloat(item.toneladas.replace(",", ".")) || 0),
              0
            );
          return sum.toFixed(2);
        });

        const maxValue = Math.max(
          ...litrosPorTipo.map((v) => parseFloat(v)),
          ...toneladasPorTipo.map((v) => parseFloat(v))
        );
        // Aumenta o multiplicador para dar mais espaço acima das barras.
        const yMax = maxValue ? maxValue * 1.35 : 10; // Alterado de 1.25 para 1.35 para mais espaço

        const canvas = document.getElementById("residuosChart");
        const ctx = canvas.getContext("2d");
        // Atualizar tamanho do canvas dinamicamente
        if (chartContainer) {
          // Garante que chartContainer exista
          canvas.width = chartContainer.clientWidth - 20; // Subtrair padding e margens
          canvas.height = chartContainer.clientHeight - 20;
        }

        // Já define o fundo do canvas como branco.
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Obter as cores do tema atual para o texto e as grades do gráfico
        const computedStyle = getComputedStyle(document.documentElement);
        const textColor = computedStyle.getPropertyValue("--text-color").trim();
        const gridColor = computedStyle
          .getPropertyValue("--table-border-color")
          .trim();

        if (window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
          type: "bar",
          plugins: [ChartDataLabels],
          data: {
            labels: tipos,
            datasets: [
              {
                label: "Litros",
                data: litrosPorTipo,
                backgroundColor: "rgba(75, 192, 192, 0.6)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1,
                stack: "Stack 0",
              },
              {
                label: "Toneladas",
                data: toneladasPorTipo,
                backgroundColor: "rgba(255, 99, 132, 0.6)",
                borderColor: "rgba(255, 99, 132, 1)",
                borderWidth: 1,
                stack: "Stack 0",
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            // Adiciona padding ao layout do gráfico
            layout: {
              padding: {
                top: 40, // Aumentado para dar mais espaço no topo
                right: 20, // Adiciona 20px de padding à direita
                bottom: 0,
                left: 0,
              },
            },
            scales: {
              x: {
                ticks: {
                  color: textColor, // Cor dos rótulos do eixo X
                },
                grid: {
                  color: gridColor, // Cor das linhas de grade do eixo X
                },
              },
              y: {
                beginAtZero: true,
                max: yMax,
                stacked: true,
                grid: {
                  display: false,
                  color: gridColor, // Cor das linhas de grade do eixo Y
                },
                ticks: {
                  display: false,
                  color: textColor, // Cor dos rótulos do eixo Y
                },
              },
            },
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: textColor, // Cor do texto da legenda
                },
              },
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: (value, ctx) => {
                  if (parseFloat(value) > 0) {
                    return ctx.dataset.label === "Litros" ||
                      ctx.dataset.label === "Toneladas"
                      ? value
                      : "";
                  }
                  return "";
                },
                color: textColor, // Cor dos rótulos de dados
                font: { weight: "bold" },
                offset: 5,
              },
            },
          },
        });
        // Forçar resize após renderização
        window.myChart.resize();
      }

      // Função de throttling
      function throttle(func, delay) {
        let timeoutId;
        return function (...args) {
          if (!timeoutId) {
            timeoutId = setTimeout(() => {
              func.apply(this, args);
              timeoutId = null;
            }, delay);
          }
        };
      }

      // Listener para redimensionamento da janela, agora com throttling
      window.addEventListener(
        "resize",
        throttle(() => {
          if (
            window.myChart &&
            document.getElementById("chartContainer").style.display !== "none"
          ) {
            updateChart(
              JSON.parse(localStorage.getItem("residuosData") || "[]")
            );
          }
        }, 200)
      ); // Atraso de 200ms

      // Aplica filtros e renderiza a tabela e o gráfico
      function applyFiltersAndRender(filterText, selectedMonth) {
        let filteredData = storedData;

        // Apply text filter
        if (filterText) {
          const lowerCaseFilter = filterText.toLowerCase();
          filteredData = filteredData.filter((item) =>
            Object.values(item).some((value) =>
              String(value).toLowerCase().includes(lowerCaseFilter)
            )
          );
        }

        // Apply month filter
        if (selectedMonth) {
          filteredData = filteredData.filter(
            (item) => item.dataEmissao.split("/")[1] === selectedMonth
          );
        }

        renderTable(filteredData);
        updateChart(filteredData);
      }

      document.getElementById("monthFilter").addEventListener("change", (e) => {
        applyFiltersAndRender(
          document.getElementById("filterInput").value,
          e.target.value
        );
      });

      function toggleButtons() {
        const buttonsContainer = document.getElementById("buttonsContainer");
        const clearButton = document.getElementById("clearHistory");
        const downloadButton = document.getElementById("downloadChart");
        const copyButton = document.getElementById("copyButton");
        const filterControlsGroup = document.getElementById(
          "filterControlsGroup"
        );
        const monthSelect = document.getElementById("monthFilter");
        const chartContainer = document.getElementById("chartContainer");
        const clearFilter = document.getElementById("clearFilter");
        const backButton = document.getElementById("backButton");
        const toggleTableBtn = document.getElementById("toggleTableVisibility");

        if (storedData.length > 0) {
          if (clearButton) clearButton.style.display = "inline-block";
          if (downloadButton) downloadButton.style.display = "inline-block";
          if (copyButton) copyButton.style.display = "inline-block";
          if (filterControlsGroup) filterControlsGroup.style.display = "flex";
          if (monthSelect) monthSelect.style.display = "inline-block";
          if (chartContainer) chartContainer.style.display = "block";
          if (clearFilter)
            clearFilter.style.display = document.getElementById("filterInput")
              .value
              ? "inline-block"
              : "none";
          if (buttonsContainer)
            buttonsContainer.style.justifyContent = "center";
          if (backButton) {
            backButton.style.margin = "5px";
          }
          if (toggleTableBtn) toggleTableBtn.style.display = "inline-block";
        } else {
          if (clearButton) clearButton.style.display = "none";
          if (downloadButton) downloadButton.style.display = "none";
          if (copyButton) copyButton.style.display = "none";
          if (filterControlsGroup) filterControlsGroup.style.display = "none";
          if (monthSelect) monthSelect.style.display = "none";
          if (chartContainer) chartContainer.style.display = "none";
          if (clearFilter) clearFilter.style.display = "none";
          if (toggleTableBtn) toggleTableBtn.style.display = "none";

          if (backButton) {
            backButton.style.display = "inline-block";
            backButton.style.margin = "0 auto";
          }
          if (buttonsContainer)
            buttonsContainer.style.justifyContent = "center";
        }
      }

      document.getElementById("downloadChart").addEventListener("click", () => {
        const link = document.createElement("a");
        link.download = `grafico_residuos_${
          new Date().toISOString().split("T")[0]
        }.png`;
        const chartImage = window.myChart.toBase64Image();
        link.href = chartImage;
        link.click();
      });

      // Função para copiar texto para a área de transferência
      function copyToClipboard(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        // Torna o textarea invisível
        textarea.style.position = "fixed";
        textarea.style.top = "0";
        textarea.style.left = "0";
        textarea.style.width = "1em";
        textarea.style.height = "1em";
        textarea.style.border = "none";
        textarea.style.outline = "none";
        textarea.style.boxShadow = "none";
        textarea.style.background = "transparent";
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        try {
          const successful = document.execCommand("copy");
          return successful;
        } catch (err) {
          console.error("Erro ao copiar:", err);
          return false;
        } finally {
          document.body.removeChild(textarea);
        }
      }

      document.getElementById("copyButton").addEventListener("click", () => {
        const tableRows = document.querySelectorAll(
          "#historyTable table tbody tr"
        );
        if (tableRows.length > 0) {
          const copyText = Array.from(tableRows)
            .map((row) => {
              return Array.from(row.cells)
                .map((cell) => cell.textContent)
                .join("\t");
            })
            .join("\n");
          if (copyToClipboard(copyText)) {
            showAlertModal(
              "Dados copiados para a área de transferência!",
              "success"
            );
          } else {
            showAlertModal("Erro ao copiar os dados.", "error");
          }
        } else {
          showAlertModal("Nenhum dado para copiar.", "no_data");
        }
      });

      document.getElementById("clearFilter").addEventListener("click", () => {
        document.getElementById("filterInput").value = "";
        document.getElementById("monthFilter").value = ""; // Clear month filter too
        applyFiltersAndRender("", ""); // Re-render with no filters
        document.getElementById("clearFilter").style.display = "none";
        document.getElementById("filterInput").focus();
      });

      // Nova função para ocultar/exibir a tabela
      function toggleTableVisibility(forceState = null) {
        const tableContainer = document.getElementById("historyTable");
        const toggleTableBtn = document.getElementById("toggleTableVisibility");

        if (!tableContainer || !toggleTableBtn) return;

        if (forceState !== null) {
          isTableVisible = forceState;
        } else {
          isTableVisible = !isTableVisible;
        }

        if (isTableVisible) {
          tableContainer.style.opacity = "1";
          tableContainer.style.height = "auto"; // Reverte para altura automática
          tableContainer.style.overflow = "auto"; // Reverte para overflow automático
          toggleTableBtn.innerHTML =
            '<i class="fas fa-eye-slash"></i> Ocultar Tabela';
        } else {
          tableContainer.style.opacity = "0";
          tableContainer.style.height = "0"; // Define altura para 0
          tableContainer.style.overflow = "hidden"; // Oculta o overflow
          toggleTableBtn.innerHTML = '<i class="fas fa-eye"></i> Exibir Tabela';
        }
      }

      // Adiciona listener para o botão de toggle da tabela
      document
        .getElementById("toggleTableVisibility")
        .addEventListener("click", () => toggleTableVisibility());

      // Função para trocar a imagem do rodapé e reproduzir áudio
      function swapFooterImage(imgElement) {
        const originalSrc = imgElement.src;
        // Adapta o caminho da imagem de blink para a página de histórico
        const blinkSrc = originalSrc.includes("footer.png")
          ? originalSrc.replace("footer.png", "blink.png")
          : "../blink.png";
        const audio = document.getElementById("blinkAudio");

        imgElement.src = blinkSrc;
        if (audio) {
          audio.currentTime = 0; // Reinicia o áudio se já estiver tocando
          audio
            .play()
            .catch((e) => console.error("Erro ao reproduzir áudio:", e));
        }
        setTimeout(() => {
          imgElement.src = originalSrc;
        }, 400); // 400 milissegundos
      }

      document.addEventListener("DOMContentLoaded", () => {
        applySavedTheme(); // Aplica o tema salvo ao carregar a página

        const themeToggleBtn = document.getElementById("themeToggle");
        if (themeToggleBtn) {
          themeToggleBtn.addEventListener("click", toggleTheme);
        }

        // Inicializa storedData e as variáveis globais aqui
        storedData = JSON.parse(localStorage.getItem("residuosData") || "[]");
        // console.log("Stored data on DOMContentLoaded:", storedData); // Log para depuração inicial

        const monthSelect = document.getElementById("monthFilter");
        // Limpar opções existentes antes de adicionar novas
        if (monthSelect) {
          monthSelect.innerHTML = '<option value="">Todos os Meses</option>';
        }

        const months = [
          ...new Set(
            storedData
              .map((item) => item.dataEmissao.split("/")[1])
              .filter((month) => month !== "Não encontrada")
          ),
        ];
        months
          .sort((a, b) => a - b)
          .forEach((month) => {
            const option = document.createElement("option");
            option.value = month;
            const monthName = new Date(2025, month - 1).toLocaleString(
              "pt-BR",
              { month: "long" }
            );
            option.text =
              monthName.charAt(0).toUpperCase() + monthName.slice(1);
            if (monthSelect) monthSelect.appendChild(option);
          });

        renderTable(storedData); // Renderiza a tabela inicialmente com todos os dados
        updateChart(storedData);
        toggleButtons();

        // Adiciona listener para a imagem do rodapé APÓS o DOM estar pronto
        const footerImage = document.getElementById("footerImage");
        if (footerImage) {
          footerImage.addEventListener("click", () =>
            swapFooterImage(footerImage)
          );
        }
      }); // Fechamento do DOMContentLoaded
    </script>
  </body>
</html>
